<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="https://miro.com/app/static/miro.uikit.css">
    <script src="https://miro.com/app/static/sdk.1.1.js"></script>
    <link href="//cdn.muicss.com/mui-0.10.3/css/mui.min.css" rel="stylesheet" type="text/css" />
    <script src="//cdn.muicss.com/mui-0.10.3/js/mui.min.js"></script>

    <style>
        .rtb-sidebar-caption {
            font-size: 14px;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.8);
            padding: 24px 0 0 24px;
        }

        .no-selected-widget {
            font-size: 18px;
            text-align: center;
            margin-top: 60px;
            color: #999;
        }

        .widget-info {
            padding: 20px 24px 0 24px;
            height: 100%;
        }

        .editor {
            width: 310px;
            height: calc(100% - 120px);
            border: 1px solid #ccc;
            padding: 10px;
            box-sizing: border-box;
            font-family: Arial;
            font-size: 14px;
            margin: 0 -10px;
            resize: none;
        }
    </style>
</head>

<body>
<!--
<div class="rtb-sidebar-caption">Extra notes</div>
<div class="no-selected-widget">
    Please select one widget <br>to add notes ✏️
</div>
-->
<div class="widget-info">
    <div id="step_number"></div>
    <h1 id="step_head"></h1>
    <div id="step_text">
    </div>
    <button class="mui-btn mui-btn--primary mui-btn--raised" onclick="stepForward()">Eteenpäin</button>
    <!--
    <p id="widget-name"></p>
    <textarea placeholder="Add some notes here. Saves locally" id="editor" class="editor">text word</textarea>
    -->
</div>
<script>
    var StepNumber = 0;
    const SHARED_STEP = "Step"

    changeState("welcome");

    async function sidebarInit() {
        StepNumber = parseInt(await getSharedValue(SHARED_STEP));
        changeState("welcome");
    }

	miro.onReady(async () => {
        // StepNumber = parseInt(await getSharedValue(SHARED_STEP));
        // changeState("welcome");
	})

    // Get a Miro Sticker to store sync data in
    async function getMiroStickerByKey(key) {
        var searchString = `${key}: `;
        var elements = await miro.board.widgets.get({
            type: "sticker"
        });
        var element = elements.find(candidate => candidate.plainText.startsWith(searchString));
        // miro.board.widgets.update([{ id: element.id, clientVisible: false}])
        return element;
    }

    // Fetch value for key from a Miro Sticker
    async function getSharedValue(key) {
        let element = await getMiroStickerByKey(key);
        if (element) {
            return await element.plainText.substring(key.length + 2); // Skip key name and ": "
        } else {
            return undefined;
        }
    }

    // Store value for key from a Sticker
    async function setSharedValue(key, value) {
        let element = await getMiroStickerByKey(key);
        let text = `${key}: ${value}`;
        if (element) {
            await miro.board.widgets.update([{ id: element.id, text: text}]);
        } else {
            await miro.board.widgets.create([
                {type: 'sticker', text: text, /* clientVisible: false, */ }
            ]);
        }
    }

    function stepForward() {
        alert("Next step")
        StepNumber++;
        setSharedValue(SHARED_STEP, StepNumber);
        changeState("welcome")
    }

    function formatPlainText(text) {
        return text.replace(/^(?!<p>)(.*)(?!<\/p>)$/gm, "<p>$1</p>");
    }

    function changeState(stateId) {
        var stateData;

        switch(stateId) {
            case "welcome":
                stateData = {
                    head: `Tervetuloa Skenaariopeliin`,
                    text: `
Skenaariopelissä ryhmällenne on annettu kaikki valta luotsata itsenne seuraavien vuosien tai vuosikymmenten halki.

Seuraavan noin 90 minuutin aikana luodaan 2–5 hengen ryhmässä yksi mahdollinen tulevaisuusskenaario teitä kiinnostavasta aiheesta. Lopuksi joku ryhmästänne kertoo siitä 2 minuutin kiteytetyn tarinan, joka kannattaa tallentaa muistoksi.

Nyt saa luvan kanssa irtautua todennäköisestä, revitellä, käyttää omaa intuitiota ja ruokkia toisten hulluja ajatuksia! Pelin ohjeet opastavat joka vaiheessa.

Aloitetaanko? Paina Eteenpäin-nappia siirtyäksesi pelin ensimmäiseen pelin kuudesta vaiheesta.
`
                }
        }
        document.getElementById("step_number").innerHTML = "Shared Step: "+StepNumber;
        document.getElementById("step_head").innerHTML = formatPlainText(stateData.head);
        document.getElementById("step_text").innerHTML = formatPlainText(stateData.text);
    }

/*
	let lastSelectedWidgetId
	let widgetName = document.querySelector('#widget-name')
	let widgetInfo = document.querySelector('.widget-info')
	let editor = document.querySelector('#editor')
	let placeholder = document.querySelector('.no-selected-widget')

	function onSelectionChange(e) {
		let selectedWidgets = e.data
		updateSelection(selectedWidgets)
	}

	function updateSelection(selectedWidgets) {
		let selectedWidget = selectedWidgets[0]
		if (selectedWidgets.length === 1) {
			showElement(widgetInfo)
			hideElement(placeholder)
			saveEditorData()
			lastSelectedWidgetId = selectedWidget.id
			widgetName.innerText = selectedWidget.type
			editor.value = getData(lastSelectedWidgetId)
		} else {
			showElement(placeholder)
			hideElement(widgetInfo)
		}
	}

	function showElement(el) {
		el.style.display = 'block'
	}

	function hideElement(el) {
		el.style.display = 'none'
	}

	hideElement(placeholder)
	hideElement(widgetInfo)

	miro.onReady(() => {
		miro.addListener(miro.enums.event.SELECTION_UPDATED, onSelectionChange)
		miro.board.selection.get().then((selectedWidgets) => {
			updateSelection(selectedWidgets)
		})
	})

	editor.addEventListener('change', saveEditorData)

	async function saveEditorData() {
		if (lastSelectedWidgetId) {
			saveData(lastSelectedWidgetId, editor.value)
			lastSelectedWidgetId = undefined
		}
	}

	const LS_KEY = 'rtb-plugin-widget-info'

	function saveData(widgetId, text) {
		let data = JSON.parse(localStorage.getItem(LS_KEY)) || {}
		data[widgetId] = text
		localStorage.setItem(LS_KEY, JSON.stringify(data))
	}

	function getData(widgetId) {
		let data = JSON.parse(localStorage.getItem(LS_KEY)) || {}
		return data[widgetId] || ''
	}
*/
</script>
</body>
</html>
