<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://kit.fontawesome.com/343a20c5e6.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="https://miro.com/app/static/miro.uikit.css">
    <script src="https://miro.com/app/static/sdk.1.1.js"></script>
    <link href="//cdn.muicss.com/mui-0.10.3/css/mui.min.css" rel="stylesheet" type="text/css" />
    <script src="//cdn.muicss.com/mui-0.10.3/js/mui.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }
        .rtb-sidebar-caption {
            font-size: 14px;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.8);
            padding: 24px 0 0 24px;
        }

        .no-selected-widget {
            font-size: 18px;
            text-align: center;
            margin-top: 60px;
            color: #999;
        }

        .widget-info {
            padding: 20px 24px 0 24px;
            height: 100%;
        }

        .editor {
            width: 310px;
            height: calc(100% - 120px);
            border: 1px solid #ccc;
            padding: 10px;
            box-sizing: border-box;
            font-family: Arial;
            font-size: 14px;
            margin: 0 -10px;
            resize: none;
        }
        .bottom_navi {
            text-align: right;
            background: white;
            position: absolute;
            box-sizing: border-box;
            padding: 2em;
            margin: 0;
            width: 100%;
            height: 7em;
            bottom: 0;
        }
    </style>
</head>

<body>
<!--
<div class="rtb-sidebar-caption">Extra notes</div>
<div class="no-selected-widget">
    Please select one widget <br>to add notes ✏️
</div>
-->
<div class="widget-info">
    <div id="step_number"></div>
    <h1 id="step_head"></h1>
    <div id="step_text">
    </div>
    <!--
    <p id="widget-name"></p>
    <textarea placeholder="Add some notes here. Saves locally" id="editor" class="editor">text word</textarea>
    -->
</div>
<div class="bottom_navi">
    <button class="mui-btn mui-btn--secondary mui-btn--raised" onclick="stepBackward()"> <i class="fas fa-backward"></i> </button>
    <button class="mui-btn mui-btn--primary mui-btn--raised" onclick="stepForward()">Eteenpäin &nbsp;<i class="fas fa-forward"></i></button>
</div>
<script>
    var StepNumber = 0;
    const SHARED_STEP = "Step";

    const stepData = [
{ title: "Tervetuloa Skenaariopeliin!", body: `
Skenaariopelissä ryhmällenne on annettu kaikki valta luotsata itsenne seuraavien vuosien tai vuosikymmenten halki.

Seuraavan noin 90 minuutin aikana luodaan 2–5 hengen ryhmässä yksi mahdollinen tulevaisuusskenaario teitä kiinnostavasta aiheesta. Lopuksi joku ryhmästänne kertoo siitä 2 minuutin kiteytetyn tarinan, joka kannattaa tallentaa muistoksi.

Nyt saa luvan kanssa irtautua todennäköisestä, revitellä, käyttää omaa intuitiota ja ruokkia toisten hulluja ajatuksia! Pelin ohjeet opastavat joka vaiheessa.

Aloitetaanko? Paina Eteenpäin-nappia siirtyäksesi pelin ensimmäiseen pelin kuudesta vaiheesta.
`},

{ title: "1/6 Me ja skenaarion luonne", body: `
Kirjoittakaa kortille, kenen näkökulmasta tulevaisuutta tarkastelette.

<i>esim. “Yle".</i>
`},

{ title: "1/6 Me ja skenaarion luonne", body: `
Kirjoittakaa kortille skenaarionne tarkasteluvuosi.

<i>esim. "2030" tai "2050"</i>
`},

{ title: "1/6 Me ja skenaarion luonne", body: `
Kirjoittakaa, minkä luonteisen skenaarion laaditte.

<i>esim. toivottava/epätoivottava, todennäköinen/epätodennäköinen</i>
`},

{ title: "2/6 Maailma vuonna {scenario_year}", body: `
Valitkaa 5 ilmiötä, jotka ovat tehneet vuoden {scenario_year} maailmasta sellaisen kuin se on.
`},

{ title: "3/6 {scenario_actor} vuonna {scenario_year}", body: `
Miettikää, mitkä ovat 3 olennaista ominaisuutta, joilla olette mukautuneet vuoden {scenario_year} maailmaan.
`},

{ title: "4/6 Miten tähän päädyttiin?", body: `
Kuvitelkaa itsenne vuoteen {scenario_year} ja muistelkaa, mitkä tapahtumat vuosina {backcast_year_4}, {backcast_year_3}, {backcast_year_2} ja {backcast_year_1} johtivat siihen, millainen {scenario_actor} on vuonna {scenario_year}.
`},

{ title: "5/6 Dokumentoi", body: `
Valmistelkaa ja kertokaa 2 minuutin tarina tulevaisuuden maailmasta, itsestänne siellä sekä kohokohdat tapahtumista, jotka siihen johtivat.

<i>Vinkki: Tarinan dokumentoimiseen voi käyttää vaikkapa videopuhelun tallennustoimintoa [Ohjeita].</i>
`},

{ title: "6/6 Jaa ja keskustele", body: `
Käyttäkää pieni hetki keskusteluun pelin tuloksista: Kerro vuorollasi muille, mikä yllätti, mikä energisoi, mikä ehkä säikäytti. Minkä ajatuksen kanssa haluat edetä pelin jälkeen, miten ja kenen kanssa.

Kiitoksia pelistä!
`},
];
    var replacements = [
        ["{scenario_actor}", "Yle"],
        ["{scenario_year}", "2030"],
        ["{backcast_year_4}", "2029"],
        ["{backcast_year_3}", "2027"],
        ["{backcast_year_2}", "2023"],
        ["{backcast_year_1}", "2021"],
    ];

    changeState(StepNumber);

	miro.onReady(async () => {
        const authorized = await miro.isAuthorized();
        if (authorized) {
            initialize();
        } else {
            miro.board.ui.openModal('not-authorized.html')
                .then(res => {
                    if (res === 'success') {
                        initialize();
                    }
                })
        }
	})

    async function initialize() {
        StepNumber = parseInt(await getSharedValue(SHARED_STEP));
        changeState(StepNumber);
    }

    // Get a Miro Sticker to store sync data in
    async function getMiroStickerByKey(key) {
        var searchString = `${key}: `;
        var elements = await miro.board.widgets.get({
            type: "sticker"
        });
        var element = elements.find(candidate => candidate.plainText.startsWith(searchString));
        // miro.board.widgets.update([{ id: element.id, clientVisible: false}])
        return element;
    }

    // Fetch value for key from a Miro Sticker
    async function getSharedValue(key) {
        let element = await getMiroStickerByKey(key);
        if (element) {
            return await element.plainText.substring(key.length + 2); // Skip key name and ": "
        } else {
            return undefined;
        }
    }

    // Store value for key from a Sticker
    async function setSharedValue(key, value) {
        let element = await getMiroStickerByKey(key);
        let text = `${key}: ${value}`;
        if (element) {
            await miro.board.widgets.update([{ id: element.id, text: text}]);
        } else {
            await miro.board.widgets.create([
                {type: 'sticker', text: text, /* clientVisible: false, */ }
            ]);
        }
    }

    function stepForward() {
        // alert("Next step")
        if (StepNumber < stepData.length-1) {
            StepNumber++;
            setSharedValue(SHARED_STEP, StepNumber);
            changeState(StepNumber)
        }
    }

    function stepBackward() {
        // alert("Previous step")
        if (StepNumber > 0) {
            StepNumber--;
            setSharedValue(SHARED_STEP, StepNumber);
            changeState(StepNumber)
        }
    }

    function formatPlainText(text) {
        var formattedText = text;
        // use string replacements
        formattedText = replacements.reduce((prev, replacementData) => prev.replace(new RegExp(replacementData[0], 'g'), replacementData[1]), formattedText);
        // add html paragraph breaks
        formattedText = formattedText.replace(/^(?!<p>)(.*)(?!<\/p>)$/gm, "<p>$1</p>");
        return formattedText;
    }

    function changeState(stateId) {
        var stateData = stepData[stateId];

        document.getElementById("step_number").innerHTML = "Shared Step: "+StepNumber;
        document.getElementById("step_head").innerHTML = formatPlainText(stateData.title);
        document.getElementById("step_text").innerHTML = formatPlainText(stateData.body);
    }

/*
	let lastSelectedWidgetId
	let widgetName = document.querySelector('#widget-name')
	let widgetInfo = document.querySelector('.widget-info')
	let editor = document.querySelector('#editor')
	let placeholder = document.querySelector('.no-selected-widget')

	function onSelectionChange(e) {
		let selectedWidgets = e.data
		updateSelection(selectedWidgets)
	}

	function updateSelection(selectedWidgets) {
		let selectedWidget = selectedWidgets[0]
		if (selectedWidgets.length === 1) {
			showElement(widgetInfo)
			hideElement(placeholder)
			saveEditorData()
			lastSelectedWidgetId = selectedWidget.id
			widgetName.innerText = selectedWidget.type
			editor.value = getData(lastSelectedWidgetId)
		} else {
			showElement(placeholder)
			hideElement(widgetInfo)
		}
	}

	function showElement(el) {
		el.style.display = 'block'
	}

	function hideElement(el) {
		el.style.display = 'none'
	}

	hideElement(placeholder)
	hideElement(widgetInfo)

	miro.onReady(() => {
		miro.addListener(miro.enums.event.SELECTION_UPDATED, onSelectionChange)
		miro.board.selection.get().then((selectedWidgets) => {
			updateSelection(selectedWidgets)
		})
	})

	editor.addEventListener('change', saveEditorData)

	async function saveEditorData() {
		if (lastSelectedWidgetId) {
			saveData(lastSelectedWidgetId, editor.value)
			lastSelectedWidgetId = undefined
		}
	}

	const LS_KEY = 'rtb-plugin-widget-info'

	function saveData(widgetId, text) {
		let data = JSON.parse(localStorage.getItem(LS_KEY)) || {}
		data[widgetId] = text
		localStorage.setItem(LS_KEY, JSON.stringify(data))
	}

	function getData(widgetId) {
		let data = JSON.parse(localStorage.getItem(LS_KEY)) || {}
		return data[widgetId] || ''
	}
*/
</script>
</body>
</html>
