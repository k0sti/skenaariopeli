<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <script
      src="https://kit.fontawesome.com/343a20c5e6.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://miro.com/app/static/sdk.1.1.js"></script>
    <link
      href="https://cdn.muicss.com/mui-0.10.3/css/mui.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <script type="text/javascript" src="util/mirotools.js"></script>
    <script type="text/javascript" src="instructions.js"></script>
    <script src="https://cdn.muicss.com/mui-0.10.3/js/mui.min.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
      }

      .top {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 4rem;
        overflow: auto;
      }

      .content {
        padding: 1.5rem 1.5rem;
      }

      .bottom_navi {
        text-align: right;
        background: white;
        position: fixed;
        box-sizing: border-box;
        padding: 0.5rem 1.5rem;
        margin: 0;
        width: 100%;
        height: 4rem;
        bottom: 0;
        display: flex;
        flex-direction: row;
        justify-items: stretch;
      }
    </style>
  </head>

  <body>
    <div class="top">
      <div class="content">
        <h1 id="step_head"></h1>
        <div id="step_text"></div>
      </div>
    </div>
    <div class="bottom_navi">
      <div style="position: absolute" id="step_number"></div>
      <button
        class="mui-btn mui-btn--secondary mui-btn--raised"
        style="padding-left: 0.8em; padding-right: 0.8em"
        onclick="stepBackward(true)"
      >
        <i class="fas fa-backward"></i>
      </button>
      <button
        class="mui-btn mui-btn--secondary mui-btn--raised"
        style="padding-left: 0.8em; padding-right: 0.8em"
        onclick="stepBackward()"
      >
        <i class="fas fa-step-backward"></i>
      </button>
      <button
        class="mui-btn mui-btn--primary mui-btn--raised"
        style="flex-grow: 1"
        onclick="stepForward()"
      >
        Eteenp√§in &nbsp;<i class="fas fa-play"></i>
      </button>
      <button
        class="mui-btn mui-btn--secondary mui-btn--raised"
        style="padding-left: 0.8em; padding-right: 0.8em"
        onclick="stepForward(true)"
      >
        <i class="fas fa-forward"></i>
      </button>
    </div>
    <script>
      const SHARED_STEP = "Step";

      var StepNumber = 0;
      var poll;
      var replacements = {
        "{scenario_actor}": "Yle",
        "{scenario_year}": "2030",
        "{backcast_year_4}": "2029",
        "{backcast_year_3}": "2027",
        "{backcast_year_2}": "2023",
        "{backcast_year_1}": "2021",
      };

      changeState(StepNumber);

      miro.onReady(async () => {
        initialize();
      });

      async function initialize() {
        StepNumber = parseInt(await mirotools.getSharedValue(SHARED_STEP));
        changeState(StepNumber);

        poll = setInterval(pollCallback, 2000);
        await miro.addListener("SELECTION_UPDATED", (e) => onMiroSelectionChange(e))

      }

      const DEAL_CARD_WIDGET_ID = "3074457350081245516";

      function onMiroSelectionChange(e) {
        let widgets = e.data;
        if (widgets.length === 1) {
          let widget = widgets[0];
          if (widget.id === DEAL_CARD_WIDGET_ID) {
            console.log("DEAL CARD!");
            let widget = (await miro.board.widgets.get({ id: "3074457350081245516" }))[0];
            await miro.board.widgets.create([{
              type: "sticker",
              text: "Hoplaa",
              x: widget.x + Math.random() * 100 - 50,
              y: widget.y + Math.random() * 20 + 100,
              scale: 0.5},
            ]);
            // Clear selection
            miro.board.selection.selectWidgets([]);
          }
        }

      }

      function deInitialize() {
        clearInterval(poll)
      }

      async function stepForward(skipToCue) {
        let stop = false;
        while (StepNumber < stepData.length - 1 && !stop) {
          if (mirotools.isMiroEnabled()) {
            await onExitState(StepNumber);
          }
          StepNumber++;
          if (!skipToCue || stepData[StepNumber].cuePoint) stop = true;
        }
        changeState(StepNumber);
        if (mirotools.isMiroEnabled()) mirotools.setSharedValue(SHARED_STEP, StepNumber);
      }

      async function stepBackward(skipToCue) {
        let stop = false;
        while (StepNumber > 0 && !stop) {
          if (mirotools.isMiroEnabled()) {
            await onExitState(StepNumber);
          }
          StepNumber--;
          if (!skipToCue || stepData[StepNumber].cuePoint) stop = true;
        }
        changeState(StepNumber);
        if (mirotools.isMiroEnabled()) mirotools.setSharedValue(SHARED_STEP, StepNumber);
      }

      function formatPlainText(text) {
        var formattedText = text;
        // use string replacements
        formattedText = Object.keys(replacements).reduce(
          (prev, key) => prev.replace(new RegExp(key, "g"), replacements[key]),
          formattedText
        );
        // add html paragraph breaks
        formattedText = formattedText.replace(
          /^(?!<p>)(.*)(?!<\/p>)$/gm,
          "<p>$1</p>"
        );
        return formattedText;
      }

      function changeState(stateId) {
        var stateData = stepData[stateId];

        document.getElementById("step_number").innerHTML = StepNumber;
        document.getElementById("step_head").innerHTML = formatPlainText(
          stateData.title
        );
        document.getElementById("step_text").innerHTML = formatPlainText(
          stateData.body
        );
      }

      async function pollCallback() {
        let sharedState = parseInt(await mirotools.getSharedValue(SHARED_STEP));
        if (StepNumber != sharedState) {
          StepNumber = sharedState;
          changeState(StepNumber);
        }
      }

      async function onExitState(state) {
        let actorResponse = await mirotools.getContainedStickerText(
          "SCENARIO_ACTOR_CONTAINER"
        );
        if (actorResponse.success) {
          replacements["{scenario_actor}"] = actorResponse.value;
        }
        let yearResponse = await mirotools.getContainedStickerText(
          "SCENARIO_YEAR_CONTAINER"
        );
        if (yearResponse.success) {
          replacements["{scenario_year}"] = yearResponse.value;
        }
        console.log("Actor: " + actorResponse.value);
        console.log("Year: " + yearResponse.value);
      }

    </script>
  </body>
</html>
