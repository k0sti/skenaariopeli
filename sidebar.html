<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <script
      src="https://kit.fontawesome.com/343a20c5e6.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://miro.com/app/static/sdk.1.1.js"></script>
    <link
      href="https://cdn.muicss.com/mui-0.10.3/css/mui.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <script type="text/javascript" src="util/mirotools.js"></script>
    <script type="text/javascript" src="instructions.js"></script>
    <script src="https://cdn.muicss.com/mui-0.10.3/js/mui.min.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
      }

      .widget-info {
        padding: 20px 24px 8em 24px;
        height: 100%;
      }

      .editor {
        width: 310px;
        height: calc(100% - 120px);
        border: 1px solid #ccc;
        padding: 10px;
        box-sizing: border-box;
        font-family: Arial;
        font-size: 14px;
        margin: 0 -10px;
        resize: none;
      }
      .bottom_navi {
        text-align: right;
        background: white;
        position: fixed;
        box-sizing: border-box;
        padding: 2em;
        margin: 0;
        width: 100%;
        height: 7em;
        bottom: 0;
        display: flex;
        flex-direction: row;
        justify-items: stretch;
      }
    </style>
  </head>

  <body>
    <!--
<div class="rtb-sidebar-caption">Extra notes</div>
<div class="no-selected-widget">
    Please select one widget <br>to add notes ✏️
</div>
-->
    <div class="widget-info">
      <h1 id="step_head"></h1>
      <div id="step_text"></div>
      <!--
    <p id="widget-name"></p>
    <textarea placeholder="Add some notes here. Saves locally" id="editor" class="editor">text word</textarea>
    --></div>
    <div class="bottom_navi">
      <div style="position: absolute" id="step_number"></div>
      <button
        class="mui-btn mui-btn--secondary mui-btn--raised"
        style="padding-left: 0.8em; padding-right: 0.8em"
        onclick="stepBackward(true)"
      >
        <i class="fas fa-backward"></i>
      </button>
      <button
        class="mui-btn mui-btn--secondary mui-btn--raised"
        style="padding-left: 0.8em; padding-right: 0.8em"
        onclick="stepBackward()"
      >
        <i class="fas fa-step-backward"></i>
      </button>
      <button
        class="mui-btn mui-btn--primary mui-btn--raised"
        style="flex-grow: 1"
        onclick="stepForward()"
      >
        Eteenpäin &nbsp;<i class="fas fa-play"></i>
      </button>
      <button
        class="mui-btn mui-btn--secondary mui-btn--raised"
        style="padding-left: 0.8em; padding-right: 0.8em"
        onclick="stepForward(true)"
      >
        <i class="fas fa-forward"></i>
      </button>
    </div>
    <script>
      var StepNumber = 0;
      const SHARED_STEP = "Step";

      var replacements = {
        "{scenario_actor}": "Yle",
        "{scenario_year}": "2030",
        "{backcast_year_4}": "2029",
        "{backcast_year_3}": "2027",
        "{backcast_year_2}": "2023",
        "{backcast_year_1}": "2021",
      };

      changeState(StepNumber);

      miro.onReady(async () => {
        initialize();
      });

      async function initialize() {
        StepNumber = parseInt(await mirotools.getSharedValue(SHARED_STEP));
        changeState(StepNumber);

        var poll = setInterval(pollCallback, 2000);
        // clearInterval(poll)
      }

      async function stepForward(skipToCue) {
        let stop = false;
        while (StepNumber < stepData.length - 1 && !stop) {
          if (mirotools.isMiroEnabled()) {
            await onExitState(StepNumber);
          }
          StepNumber++;
          if (!skipToCue || stepData[StepNumber].cuePoint) stop = true;
        }
        changeState(StepNumber);
        if (mirotools.isMiroEnabled()) mirotools.setSharedValue(SHARED_STEP, StepNumber);
      }

      async function stepBackward(skipToCue) {
        let stop = false;
        while (StepNumber > 0 && !stop) {
          if (mirotools.isMiroEnabled()) {
            await onExitState(StepNumber);
          }
          StepNumber--;
          if (!skipToCue || stepData[StepNumber].cuePoint) stop = true;
        }
        changeState(StepNumber);
        if (mirotools.isMiroEnabled()) mirotools.setSharedValue(SHARED_STEP, StepNumber);
      }

      function formatPlainText(text) {
        var formattedText = text;
        // use string replacements
        formattedText = Object.keys(replacements).reduce(
          (prev, key) => prev.replace(new RegExp(key, "g"), replacements[key]),
          formattedText
        );
        // add html paragraph breaks
        formattedText = formattedText.replace(
          /^(?!<p>)(.*)(?!<\/p>)$/gm,
          "<p>$1</p>"
        );
        return formattedText;
      }

      function changeState(stateId) {
        var stateData = stepData[stateId];

        document.getElementById("step_number").innerHTML = StepNumber;
        document.getElementById("step_head").innerHTML = formatPlainText(
          stateData.title
        );
        document.getElementById("step_text").innerHTML = formatPlainText(
          stateData.body
        );
      }

      async function pollCallback() {
        let sharedState = parseInt(await mirotools.getSharedValue(SHARED_STEP));
        if (StepNumber != sharedState) {
          StepNumber = sharedState;
          changeState(StepNumber);
        }
      }

      async function onExitState(state) {
        let actorResponse = await mirotools.getContainedStickerText(
          "SCENARIO_ACTOR_CONTAINER"
        );
        if (actorResponse.success) {
          replacements["{scenario_actor}"] = actorResponse.value;
        }
        let yearResponse = await mirotools.getContainedStickerText(
          "SCENARIO_YEAR_CONTAINER"
        );
        if (yearResponse.success) {
          replacements["{scenario_year}"] = yearResponse.value;
        }
        console.log("Actor: " + actorResponse.value);
        console.log("Year: " + yearResponse.value);
      }


      /*
	let lastSelectedWidgetId
	let widgetName = document.querySelector('#widget-name')
	let widgetInfo = document.querySelector('.widget-info')
	let editor = document.querySelector('#editor')
	let placeholder = document.querySelector('.no-selected-widget')

	function onSelectionChange(e) {
		let selectedWidgets = e.data
		updateSelection(selectedWidgets)
	}

	function updateSelection(selectedWidgets) {
		let selectedWidget = selectedWidgets[0]
		if (selectedWidgets.length === 1) {
			showElement(widgetInfo)
			hideElement(placeholder)
			saveEditorData()
			lastSelectedWidgetId = selectedWidget.id
			widgetName.innerText = selectedWidget.type
			editor.value = getData(lastSelectedWidgetId)
		} else {
			showElement(placeholder)
			hideElement(widgetInfo)
		}
	}

	function showElement(el) {
		el.style.display = 'block'
	}

	function hideElement(el) {
		el.style.display = 'none'
	}

	hideElement(placeholder)
	hideElement(widgetInfo)

	miro.onReady(() => {
		miro.addListener(miro.enums.event.SELECTION_UPDATED, onSelectionChange)
		miro.board.selection.get().then((selectedWidgets) => {
			updateSelection(selectedWidgets)
		})
	})

	editor.addEventListener('change', saveEditorData)

	async function saveEditorData() {
		if (lastSelectedWidgetId) {
			saveData(lastSelectedWidgetId, editor.value)
			lastSelectedWidgetId = undefined
		}
	}

	const LS_KEY = 'rtb-plugin-widget-info'

	function saveData(widgetId, text) {
		let data = JSON.parse(localStorage.getItem(LS_KEY)) || {}
		data[widgetId] = text
		localStorage.setItem(LS_KEY, JSON.stringify(data))
	}

	function getData(widgetId) {
		let data = JSON.parse(localStorage.getItem(LS_KEY)) || {}
		return data[widgetId] || ''
	}
*/
    </script>
  </body>
</html>
